version: '3'
services:
    rabbit:
        build:
            context: ./rabbitmq
            dockerfile: Dockerfile
        hostname: zimfarm
        environment:
            - INIT_USERNAME=admin
            - INIT_PASSWORD=admin_pass
            - DISPATCHER_USERNAME=dispatcher
            - DISPATCHER_PASSWORD=dispatcher_pass
        volumes:
            - ./docker_data/rabbitmq:/var/lib/rabbitmq
        ports:
            # debug only, for using management plugin
            - 8081:15672
            # change external port(7285) to something else if needed
            - 7285:5672
        restart: always
        labels:
            - com.chrisshwli.zimfarm.name="rabbit"
    mongo:
        image: mongo:latest
        volumes:
            - ./docker_data/mongo:/data/db
        restart: always
        labels:
            - com.chrisshwli.zimfarm.name="mongo"

    proxy:
        build:
            context: ./proxy
            dockerfile: Dockerfile
        links:
            # - frontend
            - backend
        depends_on:
            # - frontend
            - backend
        ports:
            - "8080:80"
        restart: always
        labels:
            - com.chrisshwli.zimfarm.name="proxy"

#    frontend:
#        build:
#            context: ./frontend
#            dockerfile: Dockerfile
#        volumes:
            # debug only
            # - ./frontend/src:/app/src

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        environment:
            - INIT_USERNAME=admin
            - INIT_PASSWORD=admin_pass
            - DISPATCHER_USERNAME=dispatcher
            - DISPATCHER_PASSWORD=dispatcher_pass
            - DEBUG=True
        links:
            - rabbit
            - mongo
        volumes:
            - ./backend/app:/app
        depends_on:
            - rabbit
            - mongo
        restart: always
        labels:
            - com.chrisshwli.zimfarm.name="backend"
